{% extends "theme.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
    <h1>Site Monitoring Dashboard</h1>

    <div class="tiles-container">
        {% for site in data %}
        <div class="tile">
            <div class="site-name">{{ site[0] }}</div>
            <div class="uptime-percentage">{{ site[4] }}% uptime</div>
            <div class="uptime-grid">
                {% for week in site[3] %}
                <div class="week-column">
                    {% for day in week %}
                    <div class="uptime-box {{ day['status'] }}" data-date="{{ day['date'] }}" data-site-id="{{ site[5] }}"></div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Modal for displaying downtime by hour -->
    <div id="downtime-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Downtime by Hour for <span id="modal-date"></span></h2>
            <div id="downtime-hours">
                <!-- Downtime data will be displayed here -->
            </div>
        </div>
    </div>

{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Add event listeners to all uptime boxes
    document.querySelectorAll('.uptime-box').forEach(box => {
        box.addEventListener('click', async (event) => {
            const date = event.target.dataset.date;
            const siteId = event.target.dataset.siteId;

            // Open the modal
            const modal = document.getElementById('downtime-modal');
            modal.style.display = 'block';
            document.getElementById('modal-date').innerText = date;

            try {
                // Fetch the downtime data by hour for the selected date
                const response = await fetch(`/downtime/${siteId}/${date}`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('downtime-hours').innerHTML = `<p>${data.error}</p>`;
                } else {
                    let content = '<ul>';
                    for (const [hour, count] of Object.entries(data)) {
                        content += `<li>${hour}:00 - ${count} times down</li>`;
                    }
                    content += '</ul>';
                    document.getElementById('downtime-hours').innerHTML = content;
                }
            } catch (err) {
                document.getElementById('downtime-hours').innerHTML = '<p>Failed to fetch downtime data.</p>';
            }
        });
    });

    // Close the modal when the user clicks on <span> (x)
    document.querySelector('.modal .close').addEventListener('click', () => {
        const modal = document.getElementById('downtime-modal');
        modal.style.display = 'none';
    });
});
</script>
