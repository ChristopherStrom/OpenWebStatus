{% extends "theme.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
    <h1>Site Monitoring Dashboard</h1>

    <div class="tiles-container">
        {% for site in data %}
        <div class="tile">
            <div class="site-name">{{ site[0] }}</div>
            <div class="uptime-percentage">{{ site[4] }}% uptime</div>
            <div class="uptime-grid">
                {% for week in site[3] %}
                <div class="week-column">
                    {% for day in week %}
                    <div class="uptime-box {{ day['status'] }}" data-date="{{ day['date'] }}" data-site-id="{{ loop.parent.parentloop.index }}">
                        {{ day['date'] }}
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        document.querySelectorAll('.uptime-box').forEach(box => {
            box.addEventListener('click', function() {
                const siteId = this.getAttribute('data-site-id');
                const date = this.getAttribute('data-date');

                fetch(`/api/downtime/${siteId}/${date}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error fetching data: ' + data.error);
                        } else {
                            // Store the response in local storage to be used in another page
                            localStorage.setItem('downtimeDetails', JSON.stringify(data.hourly_data));
                            // Redirect to the downtime page
                            window.location.href = `/downtime/${siteId}/${date}`;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Unable to fetch data. Please try again later.');
                    });
            });
        });
    </script>
{% endblock %}
